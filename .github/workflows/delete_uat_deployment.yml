name: Delete UAT deployment

on:
  push:
  pull_request:
    types: [closed]

jobs:
  push_job:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
    - name: Extract branch name
      shell: bash
      run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
      id: extract_branch
    - name: Print branch name
      run: |
        echo "Branch name is ${{ steps.extract_branch.outputs.branch }}"
    - name: Print apply release name
      run: |
        echo "apply-$(echo ${{ steps.extract_branch.outputs.branch }} | sed 's:^\w*\/::' | tr -s ' _/[]().' '-' | cut -c1-30 | sed 's/-$//')"
    - name: Print helm version
      run: |
        helm version
    - name: Authenticate to the cluster
      env:
        K8S_CLUSTER: ${{ secrets.K8S_CLUSTER_NAME_LIVE }}
        K8S_CLUSTER_CERT: ${{ secrets.K8S_CLUSTER_CERT_LIVE }}
        K8S_NAMESPACE: ${{ secrets.K8S_UAT_NAMESPACE }}
        K8S_TOKEN: ${{ secrets.K8S_UAT_TOKEN_LIVE }}
      run: |
        echo -n ${K8S_CLUSTER_CERT} | base64 -d > ./ca.crt
        kubectl config set-cluster ${K8S_CLUSTER} --certificate-authority=./ca.crt --server=https://${K8S_CLUSTER}
        kubectl config set-credentials circleci --token=${K8S_TOKEN}
        kubectl config set-context ${K8S_CLUSTER} --cluster=${K8S_CLUSTER} --user=circleci --namespace=${K8S_NAMESPACE}
        kubectl config use-context ${K8S_CLUSTER}
    - name: List UAT deployments
      run: |
        kubectl get deployments

  merge_job:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - run: |
        echo "PR #${{ github.event.number }} has been merged"
    - run: |
        ./bin/delete_uat_deployment

  close_job:
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - run: |
        echo "PR #${{ github.event.number }} has been closed without being merged"
    - run: |
        ./bin/delete_uat_deployment
