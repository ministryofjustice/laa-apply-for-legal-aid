require "rails_helper"

RSpec.describe CFE::CompareSubmission do
  describe ".call" do
    subject(:call) { described_class.call(legal_aid_application, submission_builder) }

    let(:legal_aid_application) { create(:legal_aid_application) }
    let(:cfe_submission) { create(:cfe_submission, legal_aid_application:) }
    let(:cfe_result) { create(:cfe_v5_result, submission: cfe_submission, result: legacy_result) }
    let(:submission_builder) { instance_double(CFECivil::SubmissionBuilder) }
    let(:store_compare_result) { instance_double(CFE::StoreCompareResult, call: "something") }
    let(:legacy_result) { cfe_legacy_result }
    let(:cfe_legacy_result) do
      "{\"version\":\"5\",\"timestamp\":\"2023-04-17T08:03:51.249Z\",\"success\":true,\"result_summary\":{\"wrong until another type of fail is found\":\"true\", \"overall_result\":{\"result\":\"eligible\",\"capital_contribution\":0.0,\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":0.0,\"lower_threshold\":0.0,\"result\":\"eligible\"}]},\"gross_income\":{\"total_gross_income\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":0.0,\"result\":\"pending\"}]},\"disposable_income\":{\"dependant_allowance\":0.0,\"gross_housing_costs\":0.0,\"housing_benefit\":0.0,\"net_housing_costs\":0.0,\"maintenance_allowance\":0.0,\"total_outgoings_and_allowances\":0.0,\"total_disposable_income\":0.0,\"employment_income\":{\"gross_income\":0.0,\"benefits_in_kind\":0.0,\"tax\":0.0,\"national_insurance\":0.0,\"fixed_employment_deduction\":0.0,\"net_employment_income\":0.0},\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":315.0,\"result\":\"pending\"}]},\"capital\":{\"total_liquid\":0.0,\"total_non_liquid\":0.0,\"total_vehicle\":0.0,\"total_property\":0.0,\"total_mortgage_allowance\":999999999999.0,\"total_capital\":0.0,\"pensioner_capital_disregard\":0.0,\"subject_matter_of_dispute_disregard\":0.0,\"capital_contribution\":0.0,\"assessed_capital\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":3000.0,\"result\":\"eligible\"}]}},\"assessment\":{\"id\":\"62b76dae-0bf1-4733-805f-c95eabb9255e\",\"client_reference_id\":\"L-U8B-P8P\",\"submission_date\":\"2023-04-04\",\"applicant\":{\"date_of_birth\":\"1980-01-10\",\"involvement_type\":\"applicant\",\"employed\":false,\"has_partner_opponent\":false,\"receives_qualifying_benefit\":true,\"self_employed\":false},\"gross_income\":{\"employment_income\":[],\"irregular_income\":{\"monthly_equivalents\":{\"student_loan\":0.0,\"unspecified_source\":0.0}},\"state_benefits\":{\"monthly_equivalents\":{\"all_sources\":0.0,\"cash_transactions\":0.0,\"bank_transactions\":[]}},\"other_income\":{\"monthly_equivalents\":{\"all_sources\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0},\"bank_transactions\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0},\"cash_transactions\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0}}}},\"disposable_income\":{\"monthly_equivalents\":{\"all_sources\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"bank_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"cash_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0}},\"childcare_allowance\":0.0,\"deductions\":{\"dependants_allowance\":0.0,\"disregarded_state_benefits\":0.0}},\"capital\":{\"capital_items\":{\"liquid\":[],\"non_liquid\":[],\"vehicles\":[],\"properties\":{\"main_home\":{\"value\":\"0.0\",\"outstanding_mortgage\":\"0.0\",\"percentage_owned\":\"0.0\",\"main_home\":true,\"shared_with_housing_assoc\":false,\"transaction_allowance\":\"0.0\",\"allowable_outstanding_mortgage\":\"0.0\",\"net_value\":\"0.0\",\"net_equity\":\"0.0\",\"main_home_equity_disregard\":\"100000.0\",\"assessed_equity\":\"0.0\"},\"additional_properties\":[{\"value\":\"0.0\",\"outstanding_mortgage\":\"0.0\",\"percentage_owned\":\"0.0\",\"main_home\":false,\"shared_with_housing_assoc\":false,\"transaction_allowance\":\"0.0\",\"allowable_outstanding_mortgage\":\"0.0\",\"net_value\":\"0.0\",\"net_equity\":\"0.0\",\"main_home_equity_disregard\":\"0.0\",\"assessed_equity\":\"0.0\"}]}}},\"remarks\":{}}}"
    end
    let(:cfe_civil_result) do
      "{\"version\":\"6\",\"timestamp\":\"2023-04-18T06:50:22.646Z\",\"success\":true,\"result_summary\":{\"wrong until another type of fail is found\":\"false\", \"overall_result\":{\"result\":\"eligible\",\"capital_contribution\":0.0,\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":0.0,\"lower_threshold\":0.0,\"result\":\"eligible\"}]},\"gross_income\":{\"total_gross_income\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":0.0,\"result\":\"pending\"}],\"combined_total_gross_income\":0.0},\"disposable_income\":{\"dependant_allowance\":0.0,\"gross_housing_costs\":0.0,\"housing_benefit\":0.0,\"net_housing_costs\":0.0,\"maintenance_allowance\":0.0,\"total_outgoings_and_allowances\":0.0,\"total_disposable_income\":0.0,\"employment_income\":{\"gross_income\":0.0,\"benefits_in_kind\":0.0,\"tax\":0.0,\"national_insurance\":0.0,\"fixed_employment_deduction\":0.0,\"net_employment_income\":0.0},\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":315.0,\"result\":\"pending\"}],\"combined_total_disposable_income\":0.0,\"combined_total_outgoings_and_allowances\":0.0,\"partner_allowance\":0},\"capital\":{\"pensioner_disregard_applied\":0.0,\"total_liquid\":0.0,\"total_non_liquid\":0.0,\"total_vehicle\":0.0,\"total_property\":0.0,\"total_mortgage_allowance\":999999999999.0,\"total_capital\":0.0,\"subject_matter_of_dispute_disregard\":0.0,\"capital_contribution\":0.0,\"assessed_capital\":0.0,\"total_capital_with_smod\":0.0,\"disputed_non_property_disregard\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":3000.0,\"result\":\"eligible\"}],\"pensioner_capital_disregard\":0.0,\"combined_assessed_capital\":0.0}},\"assessment\":{\"id\":\"f22a0620-af0d-40fc-8446-e65c11c72c69\",\"client_reference_id\":\"L-U8B-P8P\",\"submission_date\":\"2023-04-04\",\"level_of_help\":\"certificated\",\"applicant\":{\"date_of_birth\":\"1980-01-10\",\"involvement_type\":\"applicant\",\"employed\":false,\"has_partner_opponent\":false,\"receives_qualifying_benefit\":true,\"self_employed\":false},\"gross_income\":{\"employment_income\":[],\"irregular_income\":{\"monthly_equivalents\":{\"student_loan\":0.0,\"unspecified_source\":0.0}},\"state_benefits\":{\"monthly_equivalents\":{\"all_sources\":0.0,\"cash_transactions\":0,\"bank_transactions\":[]}},\"other_income\":{\"monthly_equivalents\":{\"all_sources\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0},\"bank_transactions\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0},\"cash_transactions\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0}}}},\"disposable_income\":{\"monthly_equivalents\":{\"all_sources\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"bank_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"cash_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0}},\"childcare_allowance\":0.0,\"deductions\":{\"dependants_allowance\":0.0,\"disregarded_state_benefits\":0.0}},\"capital\":{\"capital_items\":{\"liquid\":[],\"non_liquid\":[],\"vehicles\":[],\"properties\":{\"main_home\":{\"value\":0.0,\"outstanding_mortgage\":0.0,\"percentage_owned\":0.0,\"main_home\":true,\"shared_with_housing_assoc\":false,\"transaction_allowance\":0.0,\"allowable_outstanding_mortgage\":0.0,\"net_value\":0.0,\"net_equity\":0.0,\"smod_allowance\":0,\"main_home_equity_disregard\":0.0,\"assessed_equity\":0.0},\"additional_properties\":[{\"value\":0.0,\"outstanding_mortgage\":0.0,\"percentage_owned\":0.0,\"main_home\":false,\"shared_with_housing_assoc\":false,\"transaction_allowance\":0.0,\"allowable_outstanding_mortgage\":0.0,\"net_value\":0.0,\"net_equity\":0.0,\"smod_allowance\":0,\"main_home_equity_disregard\":0.0,\"assessed_equity\":0.0}]}}},\"remarks\":{}}}"
    end

    before { allow(CFE::StoreCompareResult).to receive(:new).and_return(store_compare_result) }

    context "when the two results do not match" do
      before do
        allow(cfe_result).to receive(:result).and_return(cfe_legacy_result)
        allow(submission_builder).to receive(:cfe_result).and_return(cfe_civil_result)
        allow(submission_builder).to receive(:request_body).and_return({ "fake" => "return" })
      end

      it "calls CFE::StoreComparisonResult" do
        expect(store_compare_result).to receive(:call).once
        call
      end

      it { expect(call).to be false }
    end

    context "when the results match" do
      let(:legacy_result) { cfe_civil_result }

      before do
        allow(cfe_result).to receive(:result).and_return(cfe_civil_result)
        allow(submission_builder).to receive(:cfe_result).and_return(cfe_civil_result)
        allow(submission_builder).to receive(:request_body).and_return({ "fake" => "return" })
      end

      it "calls CFE::StoreComparisonResult" do
        expect(store_compare_result).to receive(:call).once
        call
      end

      it { expect(call).to be true }
    end

    context "when on UAT" do
      before do
        allow(HostEnv).to receive(:environment).and_return(:uat)
        allow(cfe_result).to receive(:result).and_return(cfe_legacy_result)
        allow(submission_builder).to receive(:cfe_result).and_return(cfe_civil_result)
        allow(submission_builder).to receive(:request_body).and_return({ "fake" => "return" })
      end

      it "calls CFE::StoreComparisonResult" do
        expect(store_compare_result).to receive(:call).once
        call
      end
    end

    context "when data is missing" do
      let(:submission_builder) { nil }

      it "raises an error" do
        expect { call }.to raise_error(StandardError, "Cannot compare CFE results")
      end
    end

    context "when there is a result with a multi array area in different sequences" do
      let(:cfe_legacy_result) { "{\"version\":\"5\",\"timestamp\":\"2023-05-02T15:27:02.055Z\",\"success\":true,\"result_summary\":{\"overall_result\":{\"result\":\"eligible\",\"capital_contribution\":0.0,\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":0.0,\"lower_threshold\":0.0,\"result\":\"eligible\"}]},\"gross_income\":{\"total_gross_income\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":0.0,\"result\":\"pending\"}]},\"disposable_income\":{\"dependant_allowance\":0.0,\"gross_housing_costs\":0.0,\"housing_benefit\":0.0,\"net_housing_costs\":0.0,\"maintenance_allowance\":0.0,\"total_outgoings_and_allowances\":0.0,\"total_disposable_income\":0.0,\"employment_income\":{\"gross_income\":0.0,\"benefits_in_kind\":0.0,\"tax\":0.0,\"national_insurance\":0.0,\"fixed_employment_deduction\":0.0,\"net_employment_income\":0.0},\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":315.0,\"result\":\"pending\"}]},\"capital\":{\"total_liquid\":600.0,\"total_non_liquid\":0.0,\"total_vehicle\":0.0,\"total_property\":0.0,\"total_mortgage_allowance\":999999999999.0,\"total_capital\":600.0,\"pensioner_capital_disregard\":0.0,\"subject_matter_of_dispute_disregard\":0.0,\"capital_contribution\":0.0,\"assessed_capital\":600.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":3000.0,\"result\":\"eligible\"}]}},\"assessment\":{\"id\":\"e1517698-c6b7-4f5a-bb35-6f7e78d9ab03\",\"client_reference_id\":\"L-12R-5YR\",\"submission_date\":\"2023-05-02\",\"applicant\":{\"date_of_birth\":\"1996-04-28\",\"involvement_type\":\"applicant\",\"employed\":null,\"has_partner_opponent\":false,\"receives_qualifying_benefit\":true,\"self_employed\":false},\"gross_income\":{\"employment_income\":[],\"irregular_income\":{\"monthly_equivalents\":{\"student_loan\":0.0,\"unspecified_source\":0.0}},\"state_benefits\":{\"monthly_equivalents\":{\"all_sources\":0.0,\"cash_transactions\":0.0,\"bank_transactions\":[]}},\"other_income\":{\"monthly_equivalents\":{\"all_sources\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0},\"bank_transactions\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0},\"cash_transactions\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0}}}},\"disposable_income\":{\"monthly_equivalents\":{\"all_sources\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"bank_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"cash_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0}},\"childcare_allowance\":0.0,\"deductions\":{\"dependants_allowance\":0.0,\"disregarded_state_benefits\":0.0}},\"capital\":{\"capital_items\":{\"liquid\":[{\"description\":\"Savings accounts\",\"value\":\"300.0\"},{\"description\":\"Current accounts\",\"value\":\"300.0\"}],\"non_liquid\":[],\"vehicles\":[{\"value\":300.0,\"loan_amount_outstanding\":0.0,\"date_of_purchase\":\"2021-05-02\",\"in_regular_use\":true,\"included_in_assessment\":false,\"assessed_value\":0.0}],\"properties\":{\"main_home\":{\"value\":\"0.0\",\"outstanding_mortgage\":\"0.0\",\"percentage_owned\":\"0.0\",\"main_home\":true,\"shared_with_housing_assoc\":false,\"transaction_allowance\":\"0.0\",\"allowable_outstanding_mortgage\":\"0.0\",\"net_value\":\"0.0\",\"net_equity\":\"0.0\",\"main_home_equity_disregard\":\"100000.0\",\"assessed_equity\":\"0.0\"},\"additional_properties\":[{\"value\":\"0.0\",\"outstanding_mortgage\":\"0.0\",\"percentage_owned\":\"0.0\",\"main_home\":false,\"shared_with_housing_assoc\":false,\"transaction_allowance\":\"0.0\",\"allowable_outstanding_mortgage\":\"0.0\",\"net_value\":\"0.0\",\"net_equity\":\"0.0\",\"main_home_equity_disregard\":\"0.0\",\"assessed_equity\":\"0.0\"}]}}},\"remarks\":{}}}" }
      let(:cfe_civil_result) { "{\"version\":\"6\",\"timestamp\":\"2023-05-04T12:08:29.739Z\",\"success\":true,\"result_summary\":{\"overall_result\":{\"result\":\"eligible\",\"capital_contribution\":0.0,\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":0.0,\"lower_threshold\":0.0,\"result\":\"eligible\"}]},\"gross_income\":{\"total_gross_income\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":0.0,\"result\":\"pending\"}],\"combined_total_gross_income\":0.0},\"disposable_income\":{\"dependant_allowance_under_16\":0,\"dependant_allowance_over_16\":0,\"dependant_allowance\":0,\"gross_housing_costs\":0.0,\"housing_benefit\":0.0,\"net_housing_costs\":0.0,\"maintenance_allowance\":0.0,\"total_outgoings_and_allowances\":0.0,\"total_disposable_income\":0.0,\"employment_income\":{\"gross_income\":0.0,\"benefits_in_kind\":0.0,\"tax\":0.0,\"national_insurance\":0.0,\"fixed_employment_deduction\":0.0,\"net_employment_income\":0.0},\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":315.0,\"result\":\"pending\"}],\"combined_total_disposable_income\":0.0,\"combined_total_outgoings_and_allowances\":0.0,\"partner_allowance\":0},\"capital\":{\"pensioner_disregard_applied\":0.0,\"total_liquid\":600.0,\"total_non_liquid\":0.0,\"total_vehicle\":0.0,\"total_property\":0.0,\"total_mortgage_allowance\":999999999999.0,\"total_capital\":600.0,\"subject_matter_of_dispute_disregard\":0.0,\"assessed_capital\":600.0,\"total_capital_with_smod\":600.0,\"disputed_non_property_disregard\":0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":3000.0,\"result\":\"eligible\"}],\"combined_disputed_capital\":0.0,\"combined_non_disputed_capital\":600.0,\"capital_contribution\":0.0,\"pensioner_capital_disregard\":0.0,\"combined_assessed_capital\":600.0}},\"assessment\":{\"id\":\"2868883f-6f01-4b31-9a8e-b664597cf452\",\"client_reference_id\":\"L-12R-5YR\",\"submission_date\":\"2023-05-02\",\"level_of_help\":\"certificated\",\"applicant\":{\"date_of_birth\":\"1996-04-28\",\"involvement_type\":\"applicant\",\"employed\":null,\"has_partner_opponent\":false,\"receives_qualifying_benefit\":true,\"self_employed\":false},\"gross_income\":{\"employment_income\":[],\"irregular_income\":{\"monthly_equivalents\":{\"student_loan\":0.0,\"unspecified_source\":0.0}},\"state_benefits\":{\"monthly_equivalents\":{\"all_sources\":0.0,\"cash_transactions\":0,\"bank_transactions\":[]}},\"other_income\":{\"monthly_equivalents\":{\"all_sources\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0},\"bank_transactions\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0},\"cash_transactions\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0}}}},\"disposable_income\":{\"monthly_equivalents\":{\"all_sources\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"bank_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"cash_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0}},\"childcare_allowance\":0.0,\"deductions\":{\"dependants_allowance\":0.0,\"disregarded_state_benefits\":0.0}},\"capital\":{\"capital_items\":{\"liquid\":[{\"description\":\"Current accounts\",\"value\":300.0},{\"description\":\"Savings accounts\",\"value\":300.0}],\"non_liquid\":[],\"vehicles\":[{\"value\":300.0,\"loan_amount_outstanding\":0.0,\"date_of_purchase\":\"2021-05-04\",\"in_regular_use\":true,\"included_in_assessment\":false,\"disregards_and_deductions\":300.0,\"assessed_value\":0.0}],\"properties\":{\"main_home\":{\"value\":0.0,\"outstanding_mortgage\":0.0,\"percentage_owned\":0.0,\"main_home\":true,\"shared_with_housing_assoc\":false,\"transaction_allowance\":0.0,\"allowable_outstanding_mortgage\":0.0,\"net_value\":0.0,\"net_equity\":0.0,\"smod_allowance\":0,\"main_home_equity_disregard\":0.0,\"assessed_equity\":0.0},\"additional_properties\":[{\"value\":0.0,\"outstanding_mortgage\":0.0,\"percentage_owned\":0.0,\"main_home\":false,\"shared_with_housing_assoc\":false,\"transaction_allowance\":0.0,\"allowable_outstanding_mortgage\":0.0,\"net_value\":0.0,\"net_equity\":0.0,\"smod_allowance\":0,\"main_home_equity_disregard\":0.0,\"assessed_equity\":0.0}]}}},\"remarks\":{}}}" }

      before do
        allow(cfe_result).to receive(:result).and_return(cfe_legacy_result)
        allow(submission_builder).to receive(:cfe_result).and_return(cfe_civil_result)
        allow(submission_builder).to receive(:request_body).and_return({ "fake" => "return" })
      end

      it { expect(call).to be true }
    end

    context "when there is a result with a multi array area with mismatched values" do
      let(:cfe_legacy_result) { "{\"version\":\"5\",\"timestamp\":\"2023-05-02T15:27:02.055Z\",\"success\":true,\"result_summary\":{\"overall_result\":{\"result\":\"eligible\",\"capital_contribution\":0.0,\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":0.0,\"lower_threshold\":0.0,\"result\":\"eligible\"}]},\"gross_income\":{\"total_gross_income\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":0.0,\"result\":\"pending\"}]},\"disposable_income\":{\"dependant_allowance\":0.0,\"gross_housing_costs\":0.0,\"housing_benefit\":0.0,\"net_housing_costs\":0.0,\"maintenance_allowance\":0.0,\"total_outgoings_and_allowances\":0.0,\"total_disposable_income\":0.0,\"employment_income\":{\"gross_income\":0.0,\"benefits_in_kind\":0.0,\"tax\":0.0,\"national_insurance\":0.0,\"fixed_employment_deduction\":0.0,\"net_employment_income\":0.0},\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":315.0,\"result\":\"pending\"}]},\"capital\":{\"total_liquid\":600.0,\"total_non_liquid\":0.0,\"total_vehicle\":0.0,\"total_property\":0.0,\"total_mortgage_allowance\":999999999999.0,\"total_capital\":600.0,\"pensioner_capital_disregard\":0.0,\"subject_matter_of_dispute_disregard\":0.0,\"capital_contribution\":0.0,\"assessed_capital\":600.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":3000.0,\"result\":\"eligible\"}]}},\"assessment\":{\"id\":\"e1517698-c6b7-4f5a-bb35-6f7e78d9ab03\",\"client_reference_id\":\"L-12R-5YR\",\"submission_date\":\"2023-05-02\",\"applicant\":{\"date_of_birth\":\"1996-04-28\",\"involvement_type\":\"applicant\",\"employed\":null,\"has_partner_opponent\":false,\"receives_qualifying_benefit\":true,\"self_employed\":false},\"gross_income\":{\"employment_income\":[],\"irregular_income\":{\"monthly_equivalents\":{\"student_loan\":0.0,\"unspecified_source\":0.0}},\"state_benefits\":{\"monthly_equivalents\":{\"all_sources\":0.0,\"cash_transactions\":0.0,\"bank_transactions\":[]}},\"other_income\":{\"monthly_equivalents\":{\"all_sources\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0},\"bank_transactions\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0},\"cash_transactions\":{\"friends_or_family\":0.0,\"maintenance_in\":0.0,\"property_or_lodger\":0.0,\"pension\":0.0}}}},\"disposable_income\":{\"monthly_equivalents\":{\"all_sources\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"bank_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"cash_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0}},\"childcare_allowance\":0.0,\"deductions\":{\"dependants_allowance\":0.0,\"disregarded_state_benefits\":0.0}},\"capital\":{\"capital_items\":{\"liquid\":[{\"description\":\"Savings accounts\",\"value\":\"300.0\"},{\"description\":\"Current accounts\",\"value\":\"300.0\"}],\"non_liquid\":[],\"vehicles\":[{\"value\":300.0,\"loan_amount_outstanding\":0.0,\"date_of_purchase\":\"2021-05-02\",\"in_regular_use\":true,\"included_in_assessment\":false,\"assessed_value\":0.0}],\"properties\":{\"main_home\":{\"value\":\"0.0\",\"outstanding_mortgage\":\"0.0\",\"percentage_owned\":\"0.0\",\"main_home\":true,\"shared_with_housing_assoc\":false,\"transaction_allowance\":\"0.0\",\"allowable_outstanding_mortgage\":\"0.0\",\"net_value\":\"0.0\",\"net_equity\":\"0.0\",\"main_home_equity_disregard\":\"100000.0\",\"assessed_equity\":\"0.0\"},\"additional_properties\":[{\"value\":\"0.0\",\"outstanding_mortgage\":\"0.0\",\"percentage_owned\":\"0.0\",\"main_home\":false,\"shared_with_housing_assoc\":false,\"transaction_allowance\":\"0.0\",\"allowable_outstanding_mortgage\":\"0.0\",\"net_value\":\"0.0\",\"net_equity\":\"0.0\",\"main_home_equity_disregard\":\"0.0\",\"assessed_equity\":\"0.0\"}]}}},\"remarks\":{}}}" }
      let(:cfe_civil_result) { "{\"version\":\"6\",\"timestamp\":\"2023-05-04T12:08:29.739Z\",\"success\":true,\"result_summary\":{\"overall_result\":{\"result\":\"eligible\",\"capital_contribution\":0.0,\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":0.0,\"lower_threshold\":0.0,\"result\":\"eligible\"}]},\"gross_income\":{\"total_gross_income\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":0.0,\"result\":\"pending\"}],\"combined_total_gross_income\":0.0},\"disposable_income\":{\"dependant_allowance_under_16\":0,\"dependant_allowance_over_16\":0,\"dependant_allowance\":0,\"gross_housing_costs\":0.0,\"housing_benefit\":0.0,\"net_housing_costs\":0.0,\"maintenance_allowance\":0.0,\"total_outgoings_and_allowances\":0.0,\"total_disposable_income\":0.0,\"employment_income\":{\"gross_income\":0.0,\"benefits_in_kind\":0.0,\"tax\":0.0,\"national_insurance\":0.0,\"fixed_employment_deduction\":0.0,\"net_employment_income\":0.0},\"income_contribution\":0.0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":315.0,\"result\":\"pending\"}],\"combined_total_disposable_income\":0.0,\"combined_total_outgoings_and_allowances\":0.0,\"partner_allowance\":0},\"capital\":{\"pensioner_disregard_applied\":0.0,\"total_liquid\":600.0,\"total_non_liquid\":0.0,\"total_vehicle\":0.0,\"total_property\":0.0,\"total_mortgage_allowance\":999999999999.0,\"total_capital\":600.0,\"subject_matter_of_dispute_disregard\":0.0,\"assessed_capital\":600.0,\"total_capital_with_smod\":600.0,\"disputed_non_property_disregard\":0,\"proceeding_types\":[{\"ccms_code\":\"DA004\",\"client_involvement_type\":\"A\",\"upper_threshold\":999999999999.0,\"lower_threshold\":3000.0,\"result\":\"eligible\"}],\"combined_disputed_capital\":0.0,\"combined_non_disputed_capital\":600.0,\"capital_contribution\":0.0,\"pensioner_capital_disregard\":0.0,\"combined_assessed_capital\":600.0}},\"assessment\":{\"id\":\"2868883f-6f01-4b31-9a8e-b664597cf452\",\"client_reference_id\":\"L-12R-5YR\",\"submission_date\":\"2023-05-02\",\"level_of_help\":\"certificated\",\"applicant\":{\"date_of_birth\":\"1996-04-28\",\"involvement_type\":\"applicant\",\"employed\":null,\"has_partner_opponent\":false,\"receives_qualifying_benefit\":true,\"self_employed\":false},\"gross_income\":{\"employment_income\":[],\"irregular_income\":{\"monthly_equivalents\":{\"student_loan\":0.0,\"unspecified_source\":0.0}},\"state_benefits\":{\"monthly_equivalents\":{\"all_sources\":0.0,\"cash_transactions\":0,\"bank_transactions\":[]}},\"other_income\":{\"monthly_equivalents\":{\"all_sources\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0},\"bank_transactions\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0},\"cash_transactions\":{\"friends_or_family\":0,\"maintenance_in\":0,\"property_or_lodger\":0,\"pension\":0}}}},\"disposable_income\":{\"monthly_equivalents\":{\"all_sources\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"bank_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0},\"cash_transactions\":{\"child_care\":0.0,\"rent_or_mortgage\":0.0,\"maintenance_out\":0.0,\"legal_aid\":0.0}},\"childcare_allowance\":0.0,\"deductions\":{\"dependants_allowance\":0.0,\"disregarded_state_benefits\":0.0}},\"capital\":{\"capital_items\":{\"liquid\":[{\"description\":\"Current accounts\",\"value\":300.0},{\"description\":\"Savings accounts\",\"value\":500.0}],\"non_liquid\":[],\"vehicles\":[{\"value\":300.0,\"loan_amount_outstanding\":0.0,\"date_of_purchase\":\"2021-05-04\",\"in_regular_use\":true,\"included_in_assessment\":false,\"disregards_and_deductions\":300.0,\"assessed_value\":0.0}],\"properties\":{\"main_home\":{\"value\":0.0,\"outstanding_mortgage\":0.0,\"percentage_owned\":0.0,\"main_home\":true,\"shared_with_housing_assoc\":false,\"transaction_allowance\":0.0,\"allowable_outstanding_mortgage\":0.0,\"net_value\":0.0,\"net_equity\":0.0,\"smod_allowance\":0,\"main_home_equity_disregard\":0.0,\"assessed_equity\":0.0},\"additional_properties\":[{\"value\":0.0,\"outstanding_mortgage\":0.0,\"percentage_owned\":0.0,\"main_home\":false,\"shared_with_housing_assoc\":false,\"transaction_allowance\":0.0,\"allowable_outstanding_mortgage\":0.0,\"net_value\":0.0,\"net_equity\":0.0,\"smod_allowance\":0,\"main_home_equity_disregard\":0.0,\"assessed_equity\":0.0}]}}},\"remarks\":{}}}" }

      before do
        allow(cfe_result).to receive(:result).and_return(cfe_legacy_result)
        allow(submission_builder).to receive(:cfe_result).and_return(cfe_civil_result)
        allow(submission_builder).to receive(:request_body).and_return({ "fake" => "return" })
      end

      it { expect(call).to be false }
    end
  end
end
